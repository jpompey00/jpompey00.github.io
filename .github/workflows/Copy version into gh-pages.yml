name: Publish versioned Godot HTML5 to gh-pages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version string to publish (e.g. v1.2.0). Required when manually running this workflow.'
        required: false
        default: ''
      export_path:
        description: 'Path to the folder containing the Godot HTML5 export (defaults to export/html5)'
        required: false
        default: 'export/html5'
      update_latest:
        description: 'If "true", update a top-level "latest" folder to point to this version'
        required: false
        default: 'false'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: publish-gh-pages-${{ github.repository }}
  cancel-in-progress: true

jobs:
  publish:
    name: Publish versioned HTML5 export to gh-pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version and inputs
        id: vars
        run: |
          if [ "${GITHUB_REF#refs/tags/}" != "$GITHUB_REF" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION='${{ github.event.inputs.version }}'
          fi

          if [ -z "$VERSION" ]; then
            echo "No version found. For tag-triggered runs, push a tag (refs/tags/vX.Y.Z). For manual runs, provide the 'version' input."
            exit 1
          fi

          EXPORT_PATH='${{ github.event.inputs.export_path }}'
          UPDATE_LATEST='${{ github.event.inputs.update_latest }}'

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "EXPORT_PATH=$EXPORT_PATH" >> $GITHUB_OUTPUT
          echo "UPDATE_LATEST=$UPDATE_LATEST" >> $GITHUB_OUTPUT

      - name: Update HTML in gh-pages branch
        run: |
          VERSION="${{ steps.vars.outputs.VERSION }}"
          TARGET_BRANCH="gh-pages"  # Change this to your target branch name
          
          # Switch to target branch
          git fetch origin $TARGET_BRANCH
          git checkout $TARGET_BRANCH
          
          # Update the index.html file
          if [ -f "index.html" ]; then
            echo "Updating version in index.html on $TARGET_BRANCH branch"
            sed -i "s|/v\.[0-9.-]*/|/$VERSION/|g" index.html
            echo "Updated index.html to point to version: $VERSION"
          else
            echo "index.html not found in $TARGET_BRANCH branch"
          fi

      - name: Commit to gh-pages branch
        run: |
          TARGET_BRANCH="gh-pages"  # Change this to your target branch name
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add index.html
          if ! git diff --cached --quiet; then
            git commit -m "Update HTML redirect to version ${{ steps.vars.outputs.VERSION }} [skip ci]"
            git push origin $TARGET_BRANCH
            echo "Committed HTML version updates to $TARGET_BRANCH branch"
          else
            echo "No changes to index.html in $TARGET_BRANCH branch"
          fi

      # ... rest of your existing steps remain the same
      - name: Debug listing of workspace
        run: |
          echo "Publishing version: ${{ steps.vars.outputs.VERSION }}"
          echo "Using export path: ${{ steps.vars.outputs.EXPORT_PATH }}"

      - name: Verify export path exists
        run: |
          VERSION="${{ steps.vars.outputs.VERSION }}"
          EXPORT_PATH="${{ steps.vars.outputs.EXPORT_PATH }}"
          if [ ! -d "$EXPORT_PATH" ]; then
            echo "Export path '$EXPORT_PATH' not found in workspace. Make sure the path exists on the ref you selected."
            exit 1
          fi

      - name: Prepare temporary version folder
        run: |
          VERSION="${{ steps.vars.outputs.VERSION }}"
          EXPORT_PATH="${{ steps.vars.outputs.EXPORT_PATH }}"
          TMPDIR=$(mktemp -d)
          mkdir -p "$TMPDIR/$VERSION"
          cp -r "$EXPORT_PATH"/* "$TMPDIR/$VERSION"/
          echo "$TMPDIR" > /tmp/godot_deploy_tmpdir

      - name: Clone or initialize gh-pages branch
        env:
          REPO_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        run: |
          set -e
          echo "Cloning gh-pages branch (if exists)..."
          if git clone --depth 1 --branch gh-pages "$REPO_URL" gh-pages 2>/dev/null; then
            echo "Cloned existing gh-pages branch."
          else
            echo "gh-pages branch does not exist; creating it in a temporary directory and pushing."
            TMPINIT=$(mktemp -d)
            pushd "$TMPINIT"
            git init
            git remote add origin "$REPO_URL"
            git checkout --orphan gh-pages
            touch .nojekyll
            git add .nojekyll
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Initialize gh-pages branch"
            git push origin HEAD:gh-pages
            popd
            rm -rf gh-pages || true
            git clone --depth 1 --branch gh-pages "$REPO_URL" gh-pages
          fi

      - name: Copy version into gh-pages and commit
        run: |
          set -e
          VERSION="${{ steps.vars.outputs.VERSION }}"
          UPDATE_LATEST="${{ steps.vars.outputs.UPDATE_LATEST }}"
          TMPDIR=$(cat /tmp/godot_deploy_tmpdir)
          pushd gh-pages

          touch .nojekyll

          mkdir -p "$VERSION"
          rm -rf "$VERSION"/*
          cp -r "$TMPDIR/$VERSION"/* "$VERSION"/

          if [ "$UPDATE_LATEST" = "true" ] || [ "$UPDATE_LATEST" = "True" ] || [ "$UPDATE_LATEST" = "1" ]; then
            rm -rf latest
            mkdir -p latest
            cp -r "$VERSION"/* latest/
            echo "Updated 'latest' to $VERSION"
          fi

          git add -A
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --cached --quiet; then
            echo "No changes to commit for version $VERSION"
          else
            git commit -m "Publish Godot HTML5 export for ${VERSION} (published by $GITHUB_ACTOR) [skip ci]"
            git push origin gh-pages
            echo "Pushed changes to gh-pages branch"
          fi
          popd

      - name: Done
        run: echo "Publish finished. Version ${{ steps.vars.outputs.VERSION }} should be available under /${{ steps.vars.outputs.VERSION }}/"
