# Publish Godot 3.6 HTML5 export into a versioned folder on the gh-pages branch.
# Triggers on tag pushes (tags matching v*) and can also be run manually (workflow_dispatch).
# Expects your HTML5 export at export/html5 by default; change export_path when running manually.
name: Publish versioned Godot HTML5 to gh-pages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version string to publish (e.g. v1.2.0). Required when manually running this workflow.'
        required: false
        default: ''
      export_path:
        description: 'Path to the folder containing the Godot HTML5 export'
        required: false
        default: 'export/html5'
      update_latest:
        description: 'If "true", update a top-level "latest" folder to point to this version'
        required: false
        default: 'false'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: publish-gh-pages-${{ github.repository }}
  cancel-in-progress: true

jobs:
  publish:
    name: Publish versioned HTML5 export to gh-pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version and inputs
        id: vars
        run: |
          # Prefer tag (for push events), otherwise use manual workflow input
          if [ "${GITHUB_REF#refs/tags/}" != "$GITHUB_REF" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi

          if [ -z "$VERSION" ]; then
            echo "No version found. For tag-triggered runs, push a tag (refs/tags/vX.Y.Z). For manual runs, provide the 'version' input."
            exit 1
          fi

          EXPORT_PATH="${{ github.event.inputs.export_path }}"
          UPDATE_LATEST="${{ github.event.inputs.update_latest }}"

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "EXPORT_PATH=$EXPORT_PATH" >> $GITHUB_OUTPUT
          echo "UPDATE_LATEST=$UPDATE_LATEST" >> $GITHUB_OUTPUT

      - name: Verify export path exists
        run: |
          VERSION="${{ steps.vars.outputs.VERSION }}"
          EXPORT_PATH="${{ steps.vars.outputs.EXPORT_PATH }}"
          echo "Publishing version: $VERSION from path: $EXPORT_PATH"
          if [ ! -d "$EXPORT_PATH" ]; then
            echo "Export path '$EXPORT_PATH' not found in workspace. Make sure your Godot HTML5 export exists at that path."
            ls -la
            exit 1
          fi

      - name: Prepare temporary version folder
        run: |
          VERSION="${{ steps.vars.outputs.VERSION }}"
          EXPORT_PATH="${{ steps.vars.outputs.EXPORT_PATH }}"
          TMPDIR=$(mktemp -d)
          rm -rf "$TMPDIR"/*
          mkdir -p "$TMPDIR/$VERSION"
          cp -r "$EXPORT_PATH"/* "$TMPDIR/$VERSION"/
          echo "$TMPDIR" > /tmp/godot_deploy_tmpdir

      - name: Clone or initialize gh-pages branch
        env:
          REPO_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        run: |
          set -e
          echo "Cloning gh-pages branch (if exists)..."
          if git clone --depth 1 --branch gh-pages "$REPO_URL" gh-pages 2>/dev/null; then
            echo "Cloned existing gh-pages branch."
          else
            echo "gh-pages branch does not exist; creating it."
            mkdir gh-pages
            pushd gh-pages
            git init
            git remote add origin "$REPO_URL"
            git checkout --orphan gh-pages
            touch .nojekyll
            git add .nojekyll
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Initialize gh-pages branch"
            git push origin HEAD:gh-pages
            popd
            git clone --depth 1 --branch gh-pages "$REPO_URL" gh-pages
          fi

      - name: Copy version into gh-pages and commit
        run: |
          set -e
          VERSION="${{ steps.vars.outputs.VERSION }}"
          UPDATE_LATEST="${{ steps.vars.outputs.UPDATE_LATEST }}"
          TMPDIR=$(cat /tmp/godot_deploy_tmpdir)
          pushd gh-pages

          touch .nojekyll

          mkdir -p "$VERSION"
          rm -rf "$VERSION"/*
          cp -r "$TMPDIR/$VERSION"/* "$VERSION"/

          if [ "$UPDATE_LATEST" = "true" ] || [ "$UPDATE_LATEST" = "True" ] || [ "$UPDATE_LATEST" = "1" ]; then
            rm -rf latest
            mkdir -p latest
            cp -r "$VERSION"/* latest/
            echo "Updated 'latest' to $VERSION"
          fi

          git add -A
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --cached --quiet; then
            echo "No changes to commit for version $VERSION"
          else
            git commit -m "Publish Godot HTML5 export for ${VERSION} (published by $GITHUB_ACTOR) [skip ci]"
            git push origin gh-pages
            echo "Pushed changes to gh-pages branch"
          fi
          popd

      - name: Done
        run: echo "Publish finished. Your version ${{ steps.vars.outputs.VERSION }} should be available at https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ steps.vars.outputs.VERSION }}/ (or your custom Pages domain)."
